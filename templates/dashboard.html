{% extends 'base.html' %} {% block title %}Dashboard - Epidemic Monitoring
System{% endblock %} {% block extra_css %}
<style>
  .table .dropdown-menu.dropdown-menu-end.show {
    position: fixed !important; /* Changed to fixed */
    inset: auto !important;
    transform: none !important;
    right: auto !important; /* Let JavaScript position it */
    left: auto !important; /* Let JavaScript position it */
    top: auto !important; /* Let JavaScript position it */
    margin-top: 0.125rem !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 9999 !important; /* Much higher z-index */
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5) !important; /* Add shadow to see it better */
  }

  /* Eliminate potential interference from other elements */
  .table .dropdown-toggle.show {
    position: relative !important;
    z-index: 9998 !important;
  }

  /* Ensure table responds to theme changes */
  .table {
    color: var(--text-primary) !important;
    background-color: var(--card-bg) !important;
    transition: var(--transition-base);
  }

  .table thead th {
    background-color: var(--primary-color);
    color: var(--text-light);
    transition: var(--transition-base);
  }

  .table tbody tr {
    transition: var(--transition-base);
  }

  .table tbody tr:hover {
    background-color: var(--gray-100);
  }

  .table td,
  .table th {
    color: var(--text-primary);
    border-color: var(--border-color);
    transition: var(--transition-base);
  }

  [data-theme="dark"] .table {
    color: var(--text-primary) !important;
    background-color: #121212 !important;
  }

  [data-theme="dark"] .table tbody {
    background-color: #1e1e1e !important;
  }

  [data-theme="dark"] .table tr {
    background-color: #1e1e1e !important;
  }

  [data-theme="dark"] .table tr:hover {
    background-color: rgba(255, 255, 255, 0.05) !important;
  }

  [data-theme="dark"] .table td {
    color: #ffffff !important;
    border-color: #333333 !important;
  }

  /* Force white text for all elements inside the table in dark mode */
  [data-theme="dark"] .table * {
    color: var(--text-primary) !important;
  }

  /* Override any other styles that might be causing the issue */
  [data-theme="dark"] .card-body {
    background-color: #1e1e1e !important;
  }

  [data-theme="dark"] .table-responsive {
    background-color: #1e1e1e !important;
  }

  /* Fix badge colors in dark mode */
  [data-theme="dark"] .badge.bg-dark {
    background-color: #343a40 !important;
  }

  [data-theme="dark"] .badge.bg-secondary {
    background-color: #6c757d !important;
  }

  [data-theme="dark"] .text-muted {
    color: var(--text-tertiary) !important;
  }

  .quick-stat-card {
    border-radius: 15px;
    transition: all 0.3s ease;
    border: none;
    height: 100%;
  }

  .quick-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }

  .stat-icon {
    font-size: 2rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
  }

  .badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
  }

  /* Actions column styling */
  .actions-cell {
    min-width: 240px;
    text-align: right;
  }

  .action-dropdown .dropdown-menu {
    left: auto;
    right: 0;
  }

  /* Dark theme table style */
  .table-dark-theme {
    background-color: var(--card-bg) !important;
    color: var(--text-primary) !important;
  }

  .table-dark-theme thead th {
    background-color: #212529 !important;
    color: #fff !important;
    border-color: #32383e !important;
  }

  .table-dark-theme tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.075) !important;
  }

  .table-dark-theme td,
  .table-dark-theme th {
    border-color: var(--border-color) !important;
  }

  /* Light theme table style */
  .table-light-theme {
    background-color: #ffffff !important;
    color: #212529 !important;
  }

  .table-light-theme thead th {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border-color: #dee2e6 !important;
  }

  .table-light-theme tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
  }

  .table-light-theme td,
  .table-light-theme th {
    border-color: #dee2e6 !important;
  }

  /* Card dark mode style */
  [data-theme="dark"] .card {
    background-color: #1e1e1e !important;
    color: var(--text-primary) !important;
    border-color: #333333 !important;
  }

  [data-theme="dark"] .card-header {
    background-color: #121212 !important;
    border-color: #333333 !important;
  }

  /* Override the table style globally for dark theme */
  [data-theme="dark"] body .table,
  [data-theme="dark"] body .table tbody,
  [data-theme="dark"] body .table tr,
  [data-theme="dark"] body .table td,
  [data-theme="dark"] body .table th {
    background-color: #1e1e1e !important;
    color: #ffffff !important;
  }

  /* Ensure proper styling of datasets table row in dark mode */
  [data-theme="dark"] .table-responsive {
    background-color: transparent !important;
  }

  [data-theme="dark"] .table tbody tr {
    background-color: #1e1e1e !important;
  }

  /* Dataset table styling */
  .checkbox-column {
    width: 50px !important;
    text-align: center;
  }

  .form-check {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0;
  }

  .form-check-input {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  tbody tr {
    transition: background-color 0.2s ease;
    cursor: pointer;
  }

  tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  /* Export buttons styling */
  .export-actions {
    transition: all 0.3s ease;
  }

  .export-actions button {
    transition: all 0.2s ease;
  }

  .export-actions button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Dark mode checkbox styling */
  [data-theme="dark"] .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }

  [data-theme="dark"] tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  /* Light mode specific styles - made stronger with !important */
  [data-theme="light"] body {
    background-color: #ffffff !important;
    color: #212529 !important;
  }

  [data-theme="light"] .table {
    background-color: #ffffff !important;
    color: #212529 !important;
  }

  [data-theme="light"] .table tbody tr {
    background-color: #ffffff !important;
    color: #212529 !important;
  }

  [data-theme="light"] .table tr:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
  }

  [data-theme="light"] .table td,
  [data-theme="light"] .table th {
    border-color: #dee2e6 !important;
    color: #212529 !important;
  }

  [data-theme="light"] .table thead th {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border-color: #dee2e6 !important;
  }

  [data-theme="light"] .card {
    background-color: #ffffff !important;
    color: #212529 !important;
    border-color: rgba(0, 0, 0, 0.125) !important;
  }

  [data-theme="light"] .card-header {
    background-color: rgba(0, 0, 0, 0.03) !important;
    border-color: rgba(0, 0, 0, 0.125) !important;
  }

  [data-theme="light"] .card-body {
    background-color: #ffffff !important;
    color: #212529 !important;
  }

  /* Make sure checkboxes are visible in light mode */
  [data-theme="light"] .form-check-input {
    background-color: #fff !important;
    border-color: #ced4da !important;
  }

  /* Set light navbar styles */
  [data-theme="light"] .navbar {
    background-color: #f8f9fa !important;
    color: #212529 !important;
  }

  [data-theme="light"] .navbar-brand,
  [data-theme="light"] .nav-link {
    color: #212529 !important;
  }
</style>

{% endblock %} {% block content %}
<div class="container my-4">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="mb-0">Your Dashboard</h1>
    <a href="{{ url_for('data.upload') }}" class="btn btn-primary">
      <i class="bi bi-plus-lg me-1"></i> Add New Dataset
    </a>
  </div>

  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="quick-stat-card card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon bg-primary-subtle text-primary me-3">
              <i class="bi bi-file-earmark-spreadsheet"></i>
            </div>
            <div>
              <h5 class="mb-0">Total Datasets</h5>
              <small class="text-muted">All your data collections</small>
            </div>
          </div>
          <h3 class="mb-0">{{ user_datasets|length }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <div class="quick-stat-card card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon bg-success-subtle text-success me-3">
              <i class="bi bi-share"></i>
            </div>
            <div>
              <h5 class="mb-0">Shared With You</h5>
              <small class="text-muted">Datasets from collaborators</small>
            </div>
          </div>
          <h3 class="mb-0">{{ shared_datasets|length }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <div class="quick-stat-card card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon bg-info-subtle text-info me-3">
              <i class="bi bi-clock-history"></i>
            </div>
            <div>
              <h5 class="mb-0">Last Activity</h5>
              <small class="text-muted">Your most recent actions</small>
            </div>
          </div>
          <h3 class="mb-0">{{ last_activity|default('Today', true) }}</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Your Datasets</h5>
          <a href="{{ url_for('data.upload') }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-lg"></i> Add New
          </a>
        </div>
        <div class="card-body">
          {% if user_datasets %}
          <form id="export-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th class="checkbox-column" style="width: 50px">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="select-all-datasets"
                        />
                      </div>
                    </th>
                    <th>NAME</th>
                    <th>TYPE</th>
                    <th>DATE</th>
                    <th>SHARING</th>
                    <th class="text-end">ACTIONS</th>
                  </tr>
                </thead>
                <tbody>
                  {% for dataset in user_datasets %}
                  <tr>
                    <td>
                      <div class="form-check">
                        <input
                          class="form-check-input dataset-checkbox"
                          type="checkbox"
                          name="dataset_ids"
                          value="{{ dataset.id }}"
                          id="dataset-{{ dataset.id }}"
                        />
                      </div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <label
                          for="dataset-{{ dataset.id }}"
                          class="fw-bold mb-0"
                          style="cursor: pointer"
                          >{{ dataset.name }}</label
                        >
                      </div>
                      <small class="text-muted"
                        >{{ dataset.description|truncate(50) }}</small
                      >
                    </td>
                    <td>
                      <span class="badge bg-dark"
                        >{{ dataset.original_format|capitalize }}</span
                      >
                      {% if dataset.has_geo %}
                      <span class="badge bg-info">Geo</span>
                      {% endif %} {% if dataset.has_time %}
                      <span class="badge bg-secondary">Time</span>
                      {% endif %}
                    </td>
                    <td class="text-nowrap">
                      {{ dataset.upload_date.strftime('%Y-%m-%d') }}
                    </td>
                    <td>
                      {% if dataset.sharing_status == 'private' %}
                      <span class="badge bg-secondary">Private</span>
                      {% elif dataset.sharing_status == 'shared' %}
                      <span class="badge bg-success">Shared</span>
                      {% else %}
                      <span class="badge bg-primary">Public</span>
                      {% endif %}
                    </td>
                    <td class="actions-cell">
                      <div class="btn-group">
                        <a
                          href="{{ url_for('data.visualize', dataset_id=dataset.id) }}"
                          class="btn btn-primary btn-sm"
                        >
                          <i class="bi bi-graph-up"></i> View
                        </a>

                        <button
                          type="button"
                          class="btn btn-outline-success btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#shareModal{{ dataset.id }}"
                        >
                          <i class="bi bi-share"></i> Share
                        </button>

                        <button
                          type="button"
                          class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteModal{{ dataset.id }}"
                        >
                          <i class="bi bi-trash"></i> Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="export-actions mt-3 d-flex justify-content-end">
              <button
                type="button"
                id="export-csv-btn"
                class="btn btn-outline-primary me-2"
                disabled
              >
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> Export CSV
              </button>
              <button
                type="button"
                id="export-json-btn"
                class="btn btn-outline-secondary"
                disabled
              >
                <i class="bi bi-file-earmark-code me-1"></i> Export JSON
              </button>
            </div>
          </form>
          {% else %}
          <div class="text-center py-5">
            <div class="mb-3">
              <i class="bi bi-file-earmark-x" style="font-size: 3rem"></i>
            </div>
            <p>You haven't uploaded any datasets yet.</p>
            <a href="{{ url_for('data.upload') }}" class="btn btn-primary"
              >Upload Dataset</a
            >
          </div>
          {% endif %}
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-6 mx-auto">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Quick Links</h5>
            </div>
            <div class="card-body">
              <div class="list-group">
                <a
                  href="{{ url_for('data.upload') }}"
                  class="list-group-item list-group-item-action"
                >
                  <i class="bi bi-upload me-2"></i> Upload New Dataset
                </a>
                <a
                  href="{{ url_for('main.explore_global_map') }}"
                  class="list-group-item list-group-item-action"
                >
                  <i class="bi bi-map me-2"></i> Explore Global Map
                </a>
                <a
                  href="{{ url_for('profile.profile') }}"
                  class="list-group-item list-group-item-action"
                >
                  <i class="bi bi-person me-2"></i> View Profile
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modals -->
{% for dataset in user_datasets %}
<div
  class="modal fade"
  id="deleteModal{{ dataset.id }}"
  tabindex="-1"
  aria-labelledby="deleteModalLabel{{ dataset.id }}"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel{{ dataset.id }}">
          Delete Dataset
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete "<strong>{{ dataset.name }}</strong>"?
        </p>
        <p class="text-danger">
          <i class="bi bi-exclamation-triangle"></i> This action cannot be
          undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <form
          method="POST"
          action="{{ url_for('data.delete_dataset', dataset_id=dataset.id) }}"
          style="display: inline-block"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Share Modals -->
{% for dataset in user_datasets %}
<div
  class="modal fade"
  id="shareModal{{ dataset.id }}"
  tabindex="-1"
  aria-labelledby="shareModalLabel{{ dataset.id }}"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shareModalLabel{{ dataset.id }}">
          Share: {{ dataset.name }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form
        method="POST"
        action="{{ url_for('data.share_dataset', dataset_id=dataset.id) }}"
      >
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="mb-3">
            <label for="email{{ dataset.id }}" class="form-label"
              >Share with:</label
            >
            <select
              name="username"
              class="form-select"
              id="username{{ dataset.id }}"
              required
            >
              <option value="">-- Select User --</option>
              {% for user in all_users %} {% if user.id != current_user.id %}
              <option value="{{ user.username }}">{{ user.username }}</option>
              {% endif %} {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="permission{{ dataset.id }}" class="form-label"
              >Permission Level:</label
            >
            <select
              class="form-select"
              id="permission{{ dataset.id }}"
              name="permission"
            >
              <option value="read">Read Only</option>
              <option value="edit">Read & Edit</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Share</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Add animation delay to cards
    document.querySelectorAll(".card-animate").forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
    });

    // Add hover effect to cards
    document.querySelectorAll(".hover-shadow").forEach((card) => {
      card.addEventListener("mouseenter", function () {
        this.classList.add("shadow");
        this.style.transform = "translateY(-5px)";
        this.style.transition = "transform 0.3s ease, box-shadow 0.3s ease";
      });

      card.addEventListener("mouseleave", function () {
        this.classList.remove("shadow");
        this.style.transform = "translateY(0)";
      });
    });

    // Check current theme on page load and apply appropriate styles
    const currentTheme = document.documentElement.getAttribute("data-theme");
    if (currentTheme === "light") {
      // Force light mode
      resetToLightMode();
    } else if (currentTheme === "dark") {
      // Make sure dark mode styles are applied
      document.querySelectorAll(".table").forEach((table) => {
        table.classList.add("table-dark-theme");
        table.classList.remove("table-light-theme");
      });
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Handle theme-specific styles for the table
    function updateTableStyles() {
      const isInDarkMode =
        document.documentElement.getAttribute("data-theme") === "dark";
      const tables = document.querySelectorAll(".table");
      const tableResponsives = document.querySelectorAll(".table-responsive");
      const tableRows = document.querySelectorAll(".table tr");
      const tableCells = document.querySelectorAll(".table td, .table th");
      const tableHeads = document.querySelectorAll(".table thead th");
      const cardBodies = document.querySelectorAll(".card-body");

      if (isInDarkMode) {
        // Apply dark styles
        document.body.classList.add("dark-mode");
        document.body.classList.remove("light-mode");

        tables.forEach((table) => {
          table.classList.add("table-dark-theme");
          table.classList.remove("table-light-theme");
        });
      } else {
        // Apply light styles
        document.body.classList.add("light-mode");
        document.body.classList.remove("dark-mode");

        tables.forEach((table) => {
          table.classList.remove("table-dark-theme");
          table.classList.add("table-light-theme");
        });
      }
    }

    // Run once on page load
    updateTableStyles();

    // Listen for theme changes
    const themeToggle = document.getElementById("theme-toggle");
    if (themeToggle) {
      themeToggle.addEventListener("click", function () {
        // Small delay to ensure the theme has changed
        setTimeout(updateTableStyles, 50);
      });
    }

    // Position dropdown menus correctly
    const dropdownToggles = document.querySelectorAll(
      ".table .dropdown-toggle"
    );
    dropdownToggles.forEach((toggle) => {
      toggle.addEventListener("click", function (e) {
        // Give the browser a moment to render the dropdown
        setTimeout(function () {
          const dropdown = document.querySelector(".table .dropdown-menu.show");
          if (dropdown) {
            // Get position of the toggle button
            const rect = toggle.getBoundingClientRect();

            // Position the dropdown relative to the button
            dropdown.style.position = "fixed";
            dropdown.style.top = rect.bottom + 5 + "px";
            dropdown.style.left =
              rect.left - dropdown.offsetWidth + rect.width + "px";

            // Force it to be visible
            dropdown.style.display = "block";
            dropdown.style.opacity = "1";
            dropdown.style.visibility = "visible";
            dropdown.style.zIndex = "9999";
          }
        }, 10);
      });
    });

    // Dataset selection handling
    const selectAllCheckbox = document.getElementById("select-all-datasets");
    const datasetCheckboxes = document.querySelectorAll(".dataset-checkbox");
    const exportCsvBtn = document.getElementById("export-csv-btn");
    const exportJsonBtn = document.getElementById("export-json-btn");
    const exportForm = document.getElementById("export-form");

    // Update export buttons based on selection
    function updateExportButtons() {
      const checkedCount = document.querySelectorAll(
        ".dataset-checkbox:checked"
      ).length;
      exportCsvBtn.disabled = checkedCount === 0;
      exportJsonBtn.disabled = checkedCount === 0;
    }

    // Select all datasets
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener("change", function () {
        datasetCheckboxes.forEach((checkbox) => {
          checkbox.checked = this.checked;
        });
        updateExportButtons();
      });
    }

    // Handle individual checkbox changes
    datasetCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", function () {
        // Check if all individual checkboxes are checked
        const allChecked = [...datasetCheckboxes].every((cb) => cb.checked);
        const anyChecked = [...datasetCheckboxes].some((cb) => cb.checked);

        // Update the "select all" checkbox
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        }

        updateExportButtons();
      });
    });

    // Handle click on dataset label to toggle checkbox
    document.querySelectorAll('label[for^="dataset-"]').forEach((label) => {
      label.addEventListener("click", function (e) {
        e.preventDefault(); // Prevent default behavior
        const checkboxId = this.getAttribute("for");
        const checkbox = document.getElementById(checkboxId);
        checkbox.checked = !checkbox.checked;

        // Trigger change event to update UI
        const event = new Event("change", { bubbles: true });
        checkbox.dispatchEvent(event);
      });
    });

    // Make the whole row clickable to toggle the checkbox
    document.querySelectorAll("tbody tr").forEach((row) => {
      row.addEventListener("click", function (e) {
        // Check if click was on the row but not on buttons, links, or the checkbox itself
        if (
          !e.target.closest("button") &&
          !e.target.closest("a") &&
          !e.target.closest(".form-check-input")
        ) {
          const checkbox = this.querySelector(".dataset-checkbox");
          if (checkbox) {
            checkbox.checked = !checkbox.checked;

            // Trigger change event
            const event = new Event("change", { bubbles: true });
            checkbox.dispatchEvent(event);
          }
        }
      });
    });

    // Export buttons functionality
    if (exportCsvBtn) {
      exportCsvBtn.addEventListener("click", function () {
        exportDatasets("csv");
      });
    }

    if (exportJsonBtn) {
      exportJsonBtn.addEventListener("click", function () {
        exportDatasets("json");
      });
    }

    // Function to export selected datasets
    function exportDatasets(format) {
      const selectedDatasets = [
        ...document.querySelectorAll(".dataset-checkbox:checked"),
      ].map((cb) => cb.value);

      if (selectedDatasets.length === 0) {
        return;
      }

      if (selectedDatasets.length === 1) {
        // If only one dataset is selected, navigate directly to export URL
        window.location.href = `/export/${selectedDatasets[0]}?format=${format}`;
      } else {
        // For multiple datasets, we need to handle through a special endpoint
        // Create a form to post the data
        const form = document.createElement("form");
        form.method = "POST";
        form.action = `/export/multiple?format=${format}`;
        form.style.display = "none";

        // Add CSRF token
        const csrfToken = document.querySelector(
          'input[name="csrf_token"]'
        ).value;
        const csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "csrf_token";
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // Add selected dataset IDs
        selectedDatasets.forEach((datasetId) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "dataset_ids";
          input.value = datasetId;
          form.appendChild(input);
        });

        // Submit the form
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Initialize on page load
    updateExportButtons();

    // Add a MutationObserver to detect theme changes
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (mutation.attributeName === "data-theme") {
          // Force apply the theme styles
          updateTableStyles();
        }
      });
    });

    // Start observing the document with the configured parameters
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    // Force apply theme on load
    updateTableStyles();

    // Force light mode function that can be called when switching from dark to light
    function forceLightModeStyles() {
      // Set proper classes
      document.body.classList.add("light-mode");
      document.body.classList.remove("dark-mode");

      // Reset all table elements to light mode
      document.querySelectorAll(".table").forEach((table) => {
        table.classList.remove("table-dark-theme");
        table.classList.add("table-light-theme");
        table.style.backgroundColor = "#ffffff";
        table.style.color = "#212529";
      });

      document.querySelectorAll(".table tbody tr").forEach((tr) => {
        tr.style.backgroundColor = "#ffffff";
        tr.style.color = "#212529";
      });

      document.querySelectorAll(".table td, .table th").forEach((cell) => {
        cell.style.color = "#212529";
        cell.style.borderColor = "#dee2e6";
      });

      document.querySelectorAll(".card").forEach((card) => {
        card.style.backgroundColor = "#ffffff";
        card.style.color = "#212529";
        card.style.borderColor = "rgba(0,0,0,.125)";
      });

      document.querySelectorAll(".card-header").forEach((header) => {
        header.style.backgroundColor = "rgba(0,0,0,.03)";
        header.style.borderColor = "rgba(0,0,0,.125)";
      });

      document.querySelectorAll(".card-body").forEach((body) => {
        body.style.backgroundColor = "#ffffff";
        body.style.color = "#212529";
      });

      // Make sure checkboxes are visible
      document.querySelectorAll(".form-check-input").forEach((input) => {
        input.style.backgroundColor = "#fff";
        input.style.borderColor = "#ced4da";
      });
    }

    // Listen for theme changes and apply appropriate styles
    const themeToggleGlobal = document.getElementById("theme-toggle");
    if (themeToggleGlobal) {
      themeToggleGlobal.addEventListener("click", function () {
        // Check if we're switching to light mode
        setTimeout(() => {
          const currentTheme =
            document.documentElement.getAttribute("data-theme");
          if (currentTheme === "light") {
            forceLightModeStyles();
          }
        }, 50);
      });
    }
  });
</script>

<!-- Force dark mode application -->
<script>
  // Additional script to force dark mode application
  function forceDarkMode() {
    if (document.documentElement.getAttribute("data-theme") === "dark") {
      // Force all table elements to take dark background
      document
        .querySelectorAll(
          ".table, .table tr, .table td, .table th, .card-body, .card"
        )
        .forEach((el) => {
          el.style.backgroundColor = "#1e1e1e";
          el.style.color = "#ffffff";
          el.style.borderColor = "#333333";
        });

      // Force all table headers dark
      document.querySelectorAll(".table thead th").forEach((th) => {
        th.style.backgroundColor = "#121212";
      });

      // Card styles
      document.querySelectorAll(".card-header").forEach((header) => {
        header.style.backgroundColor = "#121212";
      });
    }
  }

  // Run immediately and also after a delay to catch any latent styles
  document.addEventListener("DOMContentLoaded", function () {
    forceDarkMode();
    // Also run after a slight delay to ensure all styles are applied
    setTimeout(forceDarkMode, 100);
    setTimeout(forceDarkMode, 500);

    // Run whenever the theme toggle is clicked
    document
      .getElementById("theme-toggle")
      ?.addEventListener("click", function () {
        setTimeout(forceDarkMode, 100);
        setTimeout(forceDarkMode, 500);
      });
  });
</script>

<script>
  // Expose a global function to reset light mode styles
  window.resetToLightMode = function () {
    // Set root theme to light
    document.documentElement.setAttribute("data-theme", "light");

    // Reset all inline styles first
    document
      .querySelectorAll(
        ".table, .table tbody tr, .table td, .table th, .card, .card-header, .card-body, .navbar"
      )
      .forEach((el) => {
        el.removeAttribute("style");
        if (el.classList.contains("table-dark-theme")) {
          el.classList.remove("table-dark-theme");
          el.classList.add("table-light-theme");
        }
      });

    // Force light mode body style
    document.body.style.backgroundColor = "#ffffff";
    document.body.style.color = "#212529";

    // Force light mode navbar style
    document
      .querySelector(".navbar")
      .classList.remove("navbar-dark", "bg-dark");
    document.querySelector(".navbar").classList.add("navbar-light", "bg-light");
    document.querySelector(".navbar").style.backgroundColor = "#f8f9fa";

    // Force light mode table styles
    document.querySelectorAll(".table").forEach((table) => {
      table.classList.remove("table-dark-theme");
      table.classList.add("table-light-theme");
      table.style.backgroundColor = "#ffffff";
      table.style.color = "#212529";
    });

    document.querySelectorAll(".table tbody tr").forEach((tr) => {
      tr.style.backgroundColor = "#ffffff";
      tr.style.color = "#212529";
    });

    document.querySelectorAll(".table td, .table th").forEach((cell) => {
      cell.style.color = "#212529";
      cell.style.borderColor = "#dee2e6";
    });

    document.querySelectorAll(".card").forEach((card) => {
      card.style.backgroundColor = "#ffffff";
      card.style.color = "#212529";
      card.style.borderColor = "rgba(0,0,0,.125)";
    });

    document.querySelectorAll(".card-header").forEach((header) => {
      header.style.backgroundColor = "rgba(0,0,0,0.03)";
      header.style.borderColor = "rgba(0,0,0,0.125)";
    });

    document.querySelectorAll(".card-body").forEach((body) => {
      body.style.backgroundColor = "#ffffff";
      body.style.color = "#212529";
    });

    document.querySelectorAll(".form-check-input").forEach((input) => {
      input.style.backgroundColor = "#fff";
      input.style.borderColor = "#ced4da";
    });

    // Force other styles
    document.querySelectorAll(".quick-stat-card").forEach((card) => {
      card.style.backgroundColor = "#ffffff";
      card.style.color = "#212529";
    });

    // Save theme to local storage
    localStorage.setItem("theme", "light");
  };

  document.addEventListener("DOMContentLoaded", function () {
    // Reset light mode styles on page load
    resetToLightMode();
  });
</script>

{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', filename='js/dropdown-handler.js') }}"></script>
{% endblock %}
